pool:
  vmImage: ubuntu-latest

variables:
  - name: imageTag
    value: ${{ replace(variables['Build.SourceBranch'],'refs/tags/','') }}
  - name: isTagBuild
    value: ${{ startsWith(variables['Build.SourceBranch'],'refs/tags/') }}

trigger:
  - refs/tags/*

steps:
  - script: docker info
    displayName: 'Info'

  - script: docker build --tag keboola/docker-custom-python .
    displayName: 'Build'

  - script: |
      docker login -u="$(QUAY_USERNAME)" -p="$(QUAY_PASSWORD)" quay.io
      docker tag $(KBC_APP_REPOSITORY) quay.io/$(KBC_APP_REPOSITORY):$(imageTag)
      docker tag $(KBC_APP_REPOSITORY) quay.io/$(KBC_APP_REPOSITORY):latest
      docker images
      docker push quay.io/$(KBC_APP_REPOSITORY):$(imageTag)
      docker push quay.io/$(KBC_APP_REPOSITORY):latest
    condition: eq(variables['isTagBuild'], 'true')
    displayName: 'Push latest to quay.io'
